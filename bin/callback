#!/usr/bin/php -q
<?php
/*
This Callback script takes 7 arguments:
1- number to dial
2- context.exten.priority to dump number into
3- time in seconds to sleep before calling back
4- path to the AMPWEBROOT
5- path to the ASTETCDIR
6- AMI USER
6- AMI PASSWORD

eg: callback 14032448089 ext-meetme.200.1
*/
//Copyright (C) 2004 Coalescent Systems Inc. (info@coalescentsystems.ca)
//Copyright (C) 2010 Astrogen LLC
//This file is part of FreePBX.
//
//    FreePBX is free software: you can redistribute it and/or modify
//    it under the terms of the GNU General Public License as published by
//    the Free Software Foundation, either version 2 of the License, or
//    (at your option) any later version.
//
//    FreePBX is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU General Public License for more details.
//
//    You should have received a copy of the GNU General Public License
//    along with FreePBX.  If not, see <http://www.gnu.org/licenses/>.
?>

<?php

if ($argc != 8) {
  cb_fatal("Wrong number of arguments, should be:\n".$argv[0]." callback_number callback_destination delay_seconds AMPWEBROOT ASTETCDIR AMPMGRUSER AMPMGRPASS\n");
}

$callback_number = $argv[1];
$callback_destination = $argv[2];
$pause_seconds = $argv[3];

$amp_conf['AMPWEBROOT'] = $argv[4];
$amp_conf['ASTETCDIR']  = $argv[5];
$amp_conf['AMPMGRUSER'] = $argv[6];
$amp_conf['AMPMGRPASS'] = $argv[7];

// include manager functions
include $amp_conf['AMPWEBROOT'].'/admin/common/php-asmanager.php';

if($pause_seconds)
	sleep($pause_seconds);
	
// figure out context, exten, priority
$dest = explode(".",$callback_destination);
$callback_context = $dest[0];
$callback_exten = $dest[1];
$callback_priority = $dest[2];

//define the args for Originate
$channel = "Local/".$callback_number."@from-internal";
$exten = $callback_exten;
$context = $callback_context;
$priority = $callback_priority;
$timeout = "15000";
$callerid = "Callback";
$variable = "";
$account = "";
$application = "";
$data = "";

//connect to manager and dial
$astman = new AGI_AsteriskManager();
if ($res = $astman->connect("127.0.0.1", $amp_conf["AMPMGRUSER"] , $amp_conf["AMPMGRPASS"])) {
	$astman->Originate($channel, $exten, $context, $priority, $timeout, $callerid, $variable, $account, $application, $data);
} else {
	cb_fatal("Cannot connect to Asterisk Manager with ".$amp_conf["AMPMGRUSER"]."/".$amp_conf["AMPMGRPASS"]);
}
$astman->disconnect();

function cb_fatal($text) {
	echo "[FATAL] ".$text."\n";
	exit(1);
}
?>
